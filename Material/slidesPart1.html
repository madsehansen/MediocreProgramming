<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Mads E Hansen" />
  <meta name="date" content="2022-07-04" />
  <title>Mediocre programming</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Mediocre programming</h1>
  <p class="author">
Mads E Hansen
  </p>
  <p class="date">July 04, 2022</p>
</div>
<div id="object-orientation" class="title-slide slide section level1"
number="1">
<h1><span class="header-section-number">1</span> Object orientation</h1>
<ul>
<li>Object orientation is about managing complexity</li>
<li>Classes may inherit eachother</li>
<li>Class hierarchies</li>
<li>Object orientated frameworks</li>
<li>Visitor pattern</li>
</ul>
</div>
<div id="object-orientation-is-about-managing-complexity"
class="title-slide slide section level2" number="1.1">
<h1><span class="header-section-number">1.1</span> Object orientation is
about managing complexity</h1>
<ul>
<li>Make code easier to reason about by providing common interfaces</li>
<li>Make objects with a small and controlled interface</li>
<li>Interfaces can be shared between many classes of objects</li>
</ul>
</div>
<div
id="make-code-easier-to-reason-about-by-providing-common-interfaces"
class="slide section level3" number="1.1.1">
<h1><span class="header-section-number">1.1.1</span> Make code easier to
reason about by providing common interfaces</h1>
<ul>
<li>Allows objects to be substituted for other functionality</li>
<li>Less clutter of code with special treatment for each type</li>
</ul>
</div>
<div id="make-objects-with-a-small-and-controlled-interface"
class="slide section level3" number="1.1.2">
<h1><span class="header-section-number">1.1.2</span> Make objects with a
small and controlled interface</h1>
<ul>
<li><p>Should follow the Open/Close principle</p></li>
<li><p>Open for extension, let clients add functionality freely by
adding new classes that inherit</p></li>
<li><p>Closed for modification, do not let clients change the class
itself</p></li>
<li><p>All access to the object shall go through the public
interface</p>
<p>Avoid using ‘friend’, and never ever #define private public</p></li>
<li><p>Must be reasonably complete for the type, convenience can be
built from interface</p>
<p>Thus the interface shall allow all operations that are needed</p>
<p>It does not need to have all operations imaginable</p></li>
</ul>
</div>
<div id="example-class-layout" class="slide section level3"
number="1.1.3">
<h1><span class="header-section-number">1.1.3</span> Example class
layout</h1>
<div class="sourceCode" id="cb1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">class</span> MyClass <span class="op">:</span> <span class="kw">public</span> BaseClass<span class="op">,</span> <span class="kw">public</span> IMyInterface</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">public</span><span class="op">:</span> <span class="co">// Interface starts here</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="co">// Constructors</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="co">// Destructor</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="co">// Operators</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="co">// Methods</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">protected</span><span class="op">:</span> <span class="co">// Base classes only</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="co">// Interface for subclasses, typically constructors</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="co">// Virtual methods that subclasses shall override</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">private</span><span class="op">:</span> <span class="co">// Interface stops here</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="co">// Members</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="co">// Other complexity, hidden from users</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="op">};</span></span></code></pre></div>
</div>
<div id="interfaces-can-be-shared-between-many-classes-of-objects"
class="slide section level3" number="1.1.4">
<h1><span class="header-section-number">1.1.4</span> Interfaces can be
shared between many classes of objects</h1>
<ul>
<li>Sharing the interface makes the objects look the same to client
code</li>
<li>Having different classes share a useful interface makes writing
general code easier</li>
<li>Also allows for collections to hold pointers to different types</li>
<li>Thus this makes polymorphism possible</li>
</ul>
</div>
<div id="shared-interface" class="slide section level3" number="1.1.5">
<h1><span class="header-section-number">1.1.5</span> Shared
interface</h1>
<div class="sourceCode" id="cb2"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">class</span> IShape</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="kw">virtual</span> <span class="op">~</span>IShape<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="kw">virtual</span> <span class="dt">void</span> draw<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="op">};</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="kw">class</span> Circle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="op">...</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="dt">void</span> draw<span class="op">()</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="op">};</span></span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="kw">class</span> Rectangle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="op">{</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="op">...</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="dt">void</span> draw<span class="op">()</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="op">};</span></span></code></pre></div>
</div>

<div id="classes-may-inherit-eachother"
class="title-slide slide section level2" number="1.2">
<h1><span class="header-section-number">1.2</span> Classes may inherit
eachother</h1>
<ul>
<li>Should follow the Liskov principle</li>
<li>Inherit, not to reuse code, but to allow other, existing code, to
use this class</li>
<li>C++ allows multiple inheritance</li>
</ul>
</div>
<div id="should-follow-the-liskov-principle"
class="slide section level3" number="1.2.1">
<h1><span class="header-section-number">1.2.1</span> Should follow the
Liskov principle</h1>
<ul>
<li><p>Allows subclasses to be used as if they were the superclass,
without surprises</p></li>
<li><p>This may make the hierarchy different in code from math or
modelled world</p>
<p>Square is not a special case of rectangle but may be a property of
rectangle</p></li>
</ul>
</div>
<div
id="inherit-not-to-reuse-code-but-to-allow-other-existing-code-to-use-this-class"
class="slide section level3" number="1.2.2">
<h1><span class="header-section-number">1.2.2</span> Inherit, not to
reuse code, but to allow other, existing code, to use this class</h1>
<ul>
<li>Simple code reuse can be implemented via composition</li>
<li>Composed objects can hide the dependency, with inheritance this is
impossible</li>
<li>This is what polymorphism is about, allowing old code to use new
code</li>
</ul>
</div>
<div id="c-allows-multiple-inheritance" class="slide section level3"
number="1.2.3">
<h1><span class="header-section-number">1.2.3</span> C++ allows multiple
inheritance</h1>
<ul>
<li>This can cause problems with shared/common base classes</li>
<li>Only inherit from at most one base class</li>
<li>Inherit from any number of interface classes</li>
<li>Interface classes have only pure virtual methods, and a virtual
destructor, no data</li>
</ul>
</div>

<div id="class-hierarchies" class="title-slide slide section level2"
number="1.3">
<h1><span class="header-section-number">1.3</span> Class
hierarchies</h1>
<ul>
<li>Hierarchies shall be shallow</li>
<li>There is a very strong dependency on the base class(es)</li>
</ul>
</div>
<div id="hierarchies-shall-be-shallow" class="slide section level3"
number="1.3.1">
<h1><span class="header-section-number">1.3.1</span> Hierarchies shall
be shallow</h1>
<ul>
<li>A base class can hold basic, common functionality for the
subtree</li>
<li>Deep trees tend to arise with too fine level of distinctions</li>
<li>Deep trees are a sign of bad design</li>
<li>Often a deep hierarchy can be flattened by moving things out into
other classes</li>
<li>Try to avoid creating hierarchies more than 3 levels deep,
interfaces not counted</li>
</ul>
</div>
<div id="there-is-a-very-strong-dependency-on-the-base-classes"
class="slide section level3" number="1.3.2">
<h1><span class="header-section-number">1.3.2</span> There is a very
strong dependency on the base class(es)</h1>
<ul>
<li>This also causes longer build-times since the base class must be
known at class definition</li>
<li>Dependencies may come with more dependencies</li>
<li>Dependencies becomes visible to clients</li>
<li>May be hard to refactor away later</li>
</ul>
</div>

<div id="object-orientated-frameworks"
class="title-slide slide section level2" number="1.4">
<h1><span class="header-section-number">1.4</span> Object orientated
frameworks</h1>
<ul>
<li>Easy to add types</li>
<li>Hard to add functionality</li>
</ul>
</div>
<div id="easy-to-add-types" class="slide section level3" number="1.4.1">
<h1><span class="header-section-number">1.4.1</span> Easy to add
types</h1>
<ul>
<li>They need to inherit something and then they can be used in the
system</li>
<li>Framework built to handle this</li>
<li>Clients can add any number of types</li>
</ul>
</div>
<div id="hard-to-add-functionality" class="slide section level3"
number="1.4.2">
<h1><span class="header-section-number">1.4.2</span> Hard to add
functionality</h1>
<ul>
<li>Results in having to modify all the types affected</li>
<li>Framework must support the functionality</li>
<li>Affects all clients as well</li>
</ul>
</div>

<div id="example-shape-hierarchy-traditional"
class="title-slide slide section level2" number="1.5">
<h1><span class="header-section-number">1.5</span> Example: Shape
hierarchy, traditional</h1>
<div class="sourceCode" id="cb3"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">class</span> IShape</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="kw">virtual</span> <span class="op">~</span>IShape<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="kw">virtual</span> <span class="dt">void</span> draw<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="kw">virtual</span> <span class="dt">void</span> read<span class="op">(</span> <span class="bu">std::</span>istream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="kw">virtual</span> <span class="dt">void</span> write<span class="op">(</span> <span class="bu">std::</span>ostream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="op">};</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">class</span> Circle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>    <span class="op">...</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="dt">void</span> draw<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="dt">void</span> read<span class="op">(</span> <span class="bu">std::</span>istream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="dt">void</span> write<span class="op">(</span> <span class="bu">std::</span>ostream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="op">};</span></span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="kw">class</span> Rectangle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="op">{</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>    <span class="op">...</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>    <span class="dt">void</span> draw<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>    <span class="dt">void</span> read<span class="op">(</span> <span class="bu">std::</span>istream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="dt">void</span> write<span class="op">(</span> <span class="bu">std::</span>ostream<span class="op">&amp;</span> a_stream <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="op">};</span></span>
<span id="cb3-27"><a href="#cb3-27"></a></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="dt">void</span> drawShapes<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas<span class="op">,</span> <span class="bu">std::</span>vector<span class="op">&lt;</span> IShape<span class="op">*</span> <span class="op">&gt;&amp;</span> a_shapes <span class="op">)</span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>    <span class="cf">for</span> <span class="op">(</span> <span class="kw">auto</span><span class="op">*</span> shape <span class="op">:</span> a_shapes <span class="op">)</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>        shape<span class="op">-&gt;</span>draw<span class="op">(</span> a_canvas <span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="op">}</span></span></code></pre></div>
</div>

<div id="visitor-pattern" class="title-slide slide section level2"
number="1.6">
<h1><span class="header-section-number">1.6</span> Visitor pattern</h1>
<ul>
<li>Basically a way to make it easy to add functionality</li>
<li>Comes with the cost that it will be hard to add types</li>
</ul>
</div>

<div id="example-shape-hierarchy-visitor"
class="title-slide slide section level2" number="1.7">
<h1><span class="header-section-number">1.7</span> Example: Shape
hierarchy, visitor</h1>
<div class="sourceCode" id="cb4"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">class</span> IVisitor<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">class</span> IShape</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="kw">virtual</span> <span class="op">~</span>IShape<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="kw">virtual</span> <span class="dt">void</span> accept<span class="op">(</span> IVisitor<span class="op">&amp;</span> a_visitor <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="op">};</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">class</span> Circle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="op">...</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="dt">void</span> accept<span class="op">(</span> IVisitor<span class="op">&amp;</span> a_visitor <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="op">};</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="kw">class</span> Rectangle <span class="op">:</span> <span class="kw">public</span> IShape</span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="op">{</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="op">...</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>    <span class="dt">void</span> accept<span class="op">(</span> IVisitor<span class="op">&amp;</span> a_visitor <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="op">};</span></span></code></pre></div>
</div>

<div id="example-shape-hierarchy-visitor-1"
class="title-slide slide section level2" number="1.8">
<h1><span class="header-section-number">1.8</span> Example: Shape
hierarchy, visitor</h1>
<div class="sourceCode" id="cb5"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">class</span> IVisitor</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="kw">virtual</span> <span class="op">~</span>IVisitor<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="kw">virtual</span> <span class="dt">void</span> visit<span class="op">(</span> Circle<span class="op">&amp;</span> a_element <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="kw">virtual</span> <span class="dt">void</span> visit<span class="op">(</span> Rectangle<span class="op">&amp;</span> a_element <span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="op">};</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="kw">class</span> DrawVisitor <span class="op">:</span> <span class="kw">public</span> IVisitor</span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="op">...</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>    <span class="dt">void</span> visit<span class="op">(</span> Circle<span class="op">&amp;</span> a_element <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>    <span class="dt">void</span> visit<span class="op">(</span> Rectangle<span class="op">&amp;</span> a_element <span class="op">)</span> <span class="kw">final</span><span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="op">};</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="dt">void</span> forAllShapes<span class="op">(</span> IVisitor<span class="op">&amp;</span> a_visitor<span class="op">,</span> <span class="bu">std::</span>vector<span class="op">&lt;</span> IShape<span class="op">*</span> <span class="op">&gt;&amp;</span> a_shapes <span class="op">)</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="cf">for</span> <span class="op">(</span> <span class="kw">auto</span><span class="op">*</span> shape <span class="op">:</span> a_shapes <span class="op">)</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>        shape<span class="op">-&gt;</span>accept<span class="op">(</span> a_visitor <span class="op">);</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="op">}</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="dt">void</span> drawShapes<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas<span class="op">,</span> <span class="bu">std::</span>vector<span class="op">&lt;</span> IShape<span class="op">*</span> <span class="op">&gt;&amp;</span> a_shapes <span class="op">)</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>    forAllShapes<span class="op">(</span> DrawVisitor<span class="op">{</span> a_canvas <span class="op">},</span> a_shapes <span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="op">}</span></span></code></pre></div>
</div>

<div id="task" class="title-slide slide section level2" number="1.9">
<h1><span class="header-section-number">1.9</span> Task</h1>
<p>Make an Angle type/hierarchy.</p>
<p>Angles are important in a lot of code but often causes headaches,
sometimes they are victims of unit-mistakes, sometimes they are just
mixed with other things, like distances. This happens because they are
typically encoded as just free doubles.</p>
<pre><code>double angle = 0; // Radians clockwise from true north
double distance = 700; // Meters
double someCalc = angle + distance; // Makes no sense but is allowed</code></pre>
<p>The Angle should be a separate type, that cannot be abused in such
manner.</p>
<p>It should support conversion to and from</p>
<ul>
<li>degrees (-180 to +180)</li>
<li>degrees (0 to 360)</li>
<li>radians (-PI to +PI)</li>
<li>radians (0 to 2*PI)</li>
<li>mills (0 to 6400)</li>
<li>positive in clockwise direction</li>
<li>positive in counter clockwise direction</li>
</ul>
<p>It should support trigonomerty functions sin() and cos(). Also the
basic operations (+, -, *, /).</p>
<p>In a practical application, angles do not need infinite precicion nor
range. Does this affect your design?</p>
<p>Make and document some assumptions about the Angles and their
use.</p>
</div>

<div id="possible-solution" class="title-slide slide section level2"
number="1.10">
<h1><span class="header-section-number">1.10</span> Possible
solution</h1>

</div>


<div id="functional-programming"
class="title-slide slide section level1" number="2">
<h1><span class="header-section-number">2</span> Functional
programming</h1>
<ul>
<li>Functional programming is about managing complexity</li>
<li>Functions may use each other</li>
<li>Types</li>
<li>Values</li>
<li>Functional programming frameworks</li>
<li>Function template</li>
</ul>
</div>
<div id="functional-programming-is-about-managing-complexity"
class="title-slide slide section level2" number="2.1">
<h1><span class="header-section-number">2.1</span> Functional
programming is about managing complexity</h1>
<ul>
<li>Make code easier to reason about by removing assignments</li>
<li>Functions can be passed into and out of other functions</li>
<li>Template meta-programming is basically functional in nature</li>
</ul>
</div>
<div id="make-code-easier-to-reason-about-by-removing-assignments"
class="slide section level3" number="2.1.1">
<h1><span class="header-section-number">2.1.1</span> Make code easier to
reason about by removing assignments</h1>
<ul>
<li>This makes the value of variables constant</li>
<li>Less need to maintain current state in your head while reading
code</li>
<li>Initialization is <em>not</em> assignment in this context</li>
<li>Tend to lead to a lot of recursion to make loops
<ul>
<li>This can be slow, and hard to come up with reasonable solutions</li>
<li>For C++ it is often better to use assignments, but limit them to as
few as possible</li>
</ul></li>
<li>Leads to pure functions, since they cannot change anything
<ul>
<li>Pure functions are good for several reasons</li>
<li>Testability</li>
<li>Optimizer friendly</li>
<li>Easy to understand the effects/results when used</li>
</ul></li>
<li>Functional languages often use special tricks to emulate assignments
<ul>
<li>C++ has assignment and does not need these tricks</li>
<li>The general ideas around these tricks can be interesting though</li>
</ul></li>
</ul>
</div>
<div id="functions-can-be-passed-into-and-out-of-other-functions"
class="slide section level3" number="2.1.2">
<h1><span class="header-section-number">2.1.2</span> Functions can be
passed into and out of other functions</h1>
<ul>
<li>This is Higher Order Functions, a useful technique</li>
<li>Shared interfaces allows functions to be treated
polymorphically</li>
<li>Having the same interface make higher order functions more
customizable</li>
</ul>
</div>
<div id="shared-interface-1" class="slide section level3"
number="2.1.3">
<h1><span class="header-section-number">2.1.3</span> Shared
interface</h1>
<div class="sourceCode" id="cb7"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a><span class="dt">int</span> isSpace<span class="op">(</span> <span class="dt">char</span> a_ch <span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> a_ch <span class="op">==</span> <span class="ch">&#39; &#39;</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="dt">int</span> isDigit<span class="op">(</span> <span class="dt">char</span> a_ch <span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> a_ch <span class="op">&gt;=</span> <span class="ch">&#39;0&#39;</span> <span class="op">&amp;&amp;</span> a_ch <span class="op">&lt;=</span> <span class="ch">&#39;9&#39;</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> FUNC<span class="op">&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="dt">int</span> count_char<span class="op">(</span> FUNC a_func<span class="op">,</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="co">// This function actually exists in STL: std::count_if(),</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="co">// and it would be better to call that</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="dt">int</span> result <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    </span>
<span id="cb7-11"><a href="#cb7-11"></a>    <span class="cf">for</span> <span class="op">(</span> <span class="dt">char</span> ch <span class="op">:</span> a_str <span class="op">)</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>        result <span class="op">+=</span> a_func<span class="op">(</span> ch <span class="op">);</span> <span class="co">// Note assignment here, avoids recursion</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>    </span>
<span id="cb7-14"><a href="#cb7-14"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="op">}</span></span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="dt">int</span> count_space<span class="op">(</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="op">{</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    <span class="cf">return</span> count_char<span class="op">(</span> isSpace<span class="op">,</span> a_str <span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="op">}</span></span>
<span id="cb7-21"><a href="#cb7-21"></a></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="dt">int</span> count_digits<span class="op">(</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="op">{</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="cf">return</span> count_char<span class="op">(</span> isdigit<span class="op">,</span> a_str <span class="op">);</span></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="template-meta-programming-is-basically-functional-in-nature"
class="slide section level3" number="2.1.4">
<h1><span class="header-section-number">2.1.4</span> Template
meta-programming is basically functional in nature</h1>
<ul>
<li>While this is advanced, it can be nice to know if needed</li>
<li>Template meta programming works on types rather than values</li>
<li>Types cannot change into other types, they are immutable</li>
</ul>
</div>

<div id="functions-may-use-each-other"
class="title-slide slide section level2" number="2.2">
<h1><span class="header-section-number">2.2</span> Functions may use
each other</h1>
<ul>
<li>Can be passed as arguments</li>
<li>Can be used as return values</li>
<li>Composes so that it is easy to use them together</li>
<li>C++ does not have a full support for this, but it can do a lot of
it</li>
</ul>
</div>
<div id="can-be-passed-as-arguments" class="slide section level3"
number="2.2.1">
<h1><span class="header-section-number">2.2.1</span> Can be passed as
arguments</h1>
<ul>
<li>Higher order functions</li>
<li>Allows customization of functions</li>
<li>Allows functions to be more general</li>
<li>STL algorithms are based on this idea</li>
</ul>
</div>
<div id="can-be-used-as-return-values" class="slide section level3"
number="2.2.2">
<h1><span class="header-section-number">2.2.2</span> Can be used as
return values</h1>
<ul>
<li>Higher order functions</li>
<li>Functions can create function-like objects with customizations</li>
</ul>
<div class="sourceCode" id="cb8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> char_counter<span class="op">(</span> <span class="dt">char</span> a_ch <span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="cf">return</span> <span class="op">[</span>a_ch<span class="op">](</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>        <span class="dt">int</span> result <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    </span>
<span id="cb8-7"><a href="#cb8-7"></a>        <span class="cf">for</span> <span class="op">(</span> <span class="dt">char</span> ch <span class="op">:</span> a_str <span class="op">)</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>            <span class="cf">if</span> <span class="op">(</span> a_ch <span class="op">==</span> ch <span class="op">)</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>                <span class="op">++</span>result<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    </span>
<span id="cb8-11"><a href="#cb8-11"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>    <span class="op">};</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="op">}</span></span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="dt">int</span> count_space<span class="op">(</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="op">{</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>    <span class="cf">return</span> char_counter<span class="op">(</span> <span class="ch">&#39; &#39;</span> <span class="op">)(</span> a_str <span class="op">);</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="op">}</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="at">const</span> <span class="kw">auto</span> countSpace <span class="op">{</span> char_counter<span class="op">(</span> <span class="ch">&#39; &#39;</span> <span class="op">)</span> <span class="op">};</span></span>
<span id="cb8-20"><a href="#cb8-20"></a></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="dt">int</span> count_zero<span class="op">(</span> <span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>a_str <span class="op">)</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="cf">return</span> char_counter<span class="op">(</span> <span class="ch">&#39;0&#39;</span> <span class="op">)(</span> a_str <span class="op">);</span></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="at">const</span> <span class="kw">auto</span> countZero <span class="op">{</span> char_counter<span class="op">(</span> <span class="ch">&#39;0&#39;</span> <span class="op">)</span> <span class="op">};</span></span></code></pre></div>
</div>
<div id="composes-so-that-it-is-easy-to-use-them-together"
class="slide section level3" number="2.2.3">
<h1><span class="header-section-number">2.2.3</span> Composes so that it
is easy to use them together</h1>
<ul>
<li>Build complex functions by composing simpler functions</li>
<li>Writing fully composable functions require some skill and language
support</li>
</ul>
</div>
<div
id="c-does-not-have-a-full-support-for-this-but-it-can-do-a-lot-of-it"
class="slide section level3" number="2.2.4">
<h1><span class="header-section-number">2.2.4</span> C++ does not have a
full support for this, but it can do a lot of it</h1>
<ul>
<li>Lambdas are useful for return values</li>
<li>Function templates can take function-like objects as arguments</li>
<li>For specific prototypes, std::function can be used</li>
<li>Does sometimes create a bit verbose code, due to lack of language
support for things like currying</li>
</ul>
</div>

<div id="types" class="title-slide slide section level2" number="2.3">
<h1><span class="header-section-number">2.3</span> Types</h1>
<ul>
<li>Functional programming is typically very type oriented</li>
<li>Functions are overloaded on argument type</li>
</ul>
</div>
<div id="functional-programming-is-typically-very-type-oriented"
class="slide section level3" number="2.3.1">
<h1><span class="header-section-number">2.3.1</span> Functional
programming is typically very type oriented</h1>
<ul>
<li>Encode the application data model precisely</li>
<li>Make illegal state impossible</li>
<li>C++ can do a lot of this, but it is verbose due to being very
flexible</li>
<li>Code normally does not take advantage of this, which creates more
bugs</li>
</ul>
</div>
<div id="functions-are-overloaded-on-argument-type"
class="slide section level3" number="2.3.2">
<h1><span class="header-section-number">2.3.2</span> Functions are
overloaded on argument type</h1>
<ul>
<li>By handwritten for the type, if the types require special
handling</li>
<li>By templates, if the function will always look the same</li>
</ul>
</div>

<div id="values" class="title-slide slide section level2" number="2.4">
<h1><span class="header-section-number">2.4</span> Values</h1>
<ul>
<li>Functional programming uses immutable data</li>
<li>This leads to very threadsafe code</li>
<li>It is often slower than imperative programming</li>
<li>C++ allows imperative programming mixed with functional for best of
several worlds</li>
</ul>
</div>
<div id="functional-programming-uses-immutable-data"
class="slide section level3" number="2.4.1">
<h1><span class="header-section-number">2.4.1</span> Functional
programming uses immutable data</h1>
<ul>
<li>Can not be changed after creation (no assignments, only
initialization)</li>
<li>Easier to reason about, can be emulated in functions by const
variables</li>
<li>Can be shared between datastructures, may need special
datastructures for this</li>
<li>Causes more creation of data, even for minor changes</li>
</ul>
</div>
<div id="this-leads-to-very-threadsafe-code"
class="slide section level3" number="2.4.2">
<h1><span class="header-section-number">2.4.2</span> This leads to very
threadsafe code</h1>
<ul>
<li>Data that does not change is only read, this is threadsafe</li>
<li>Once a thread receives ownership of the data, it will not
change</li>
<li>No locking needed, so no deadlocks
<ul>
<li>Locking still needed while transferring data between threads, but
only there</li>
</ul></li>
<li>Functions should be pure, no dependencies to anything but
arguments</li>
<li>No side-effects, no spooky action at a distance</li>
</ul>
</div>
<div id="it-is-often-slower-than-imperative-programming"
class="slide section level3" number="2.4.3">
<h1><span class="header-section-number">2.4.3</span> It is often slower
than imperative programming</h1>
<ul>
<li>Mostly due to extra creation and copying of data</li>
<li>Many functional languages use garbage collection since it makes for
easier programming</li>
<li>Heap allocation and deallocation are expensive compared to stack
allocation</li>
<li>These features slow down the code compared to common imperative
programming</li>
</ul>
</div>
<div
id="c-allows-imperative-programming-mixed-with-functional-for-best-of-several-worlds"
class="slide section level3" number="2.4.4">
<h1><span class="header-section-number">2.4.4</span> C++ allows
imperative programming mixed with functional for best of several
worlds</h1>
<ul>
<li>This allows for selecting the model that makes sense in the code at
hand</li>
<li>Often object orientation is used for large scale (overall program
shape)</li>
<li>Functional programming is then used on small scale (function/method
and smaller features)</li>
<li>Some features are common, like benefits from types and pure
functions</li>
</ul>
</div>

<div id="functional-programming-frameworks"
class="title-slide slide section level2" number="2.5">
<h1><span class="header-section-number">2.5</span> Functional
programming frameworks</h1>
<ul>
<li>Hard to add types</li>
<li>Easy to add functionality</li>
</ul>
</div>
<div id="hard-to-add-types" class="slide section level3" number="2.5.1">
<h1><span class="header-section-number">2.5.1</span> Hard to add
types</h1>
<ul>
<li>They need to be supported by all functions they will be used in</li>
<li>Framework built to have all supported types</li>
<li>Clients can typically not extend with new types</li>
<li>Adding new types to framework causes all clients to have to modify
their functions</li>
</ul>
</div>
<div id="easy-to-add-functionality" class="slide section level3"
number="2.5.2">
<h1><span class="header-section-number">2.5.2</span> Easy to add
functionality</h1>
<ul>
<li>Clients can add any number of new functions</li>
<li>Adding new functions to framework does not affect clients</li>
</ul>
</div>

<div id="example-shapes" class="title-slide slide section level2"
number="2.6">
<h1><span class="header-section-number">2.6</span> Example: Shapes</h1>
<div class="sourceCode" id="cb9"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">struct</span> Position</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="dt">double</span> x<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="dt">double</span> y<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="op">};</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">class</span> Circle</span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>    <span class="op">...</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="dt">double</span> radius<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>    Position position<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="op">};</span></span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="kw">class</span> Rectangle</span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="op">{</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>    <span class="op">...</span></span>
<span id="cb9-19"><a href="#cb9-19"></a>    <span class="dt">double</span> height<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>    <span class="dt">double</span> width<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>    Position position<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="op">};</span></span></code></pre></div>
</div>

<div id="example-shapes-1" class="title-slide slide section level2"
number="2.7">
<h1><span class="header-section-number">2.7</span> Example: Shapes</h1>
<div class="sourceCode" id="cb10"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">using</span> Shape <span class="op">=</span> <span class="bu">std::</span>variant<span class="op">&lt;</span> Circle<span class="op">,</span> Rectangle <span class="op">&gt;;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="dt">void</span> draw<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas<span class="op">,</span> <span class="at">const</span> Circle<span class="op">&amp;</span> a_shape <span class="op">)</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="op">...</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="op">}</span></span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="dt">void</span> draw<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas<span class="op">,</span> <span class="at">const</span> Rectangle<span class="op">&amp;</span> a_shape <span class="op">)</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>    <span class="op">...</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="dt">void</span> drawShapes<span class="op">(</span> Canvas<span class="op">&amp;</span> a_canvas<span class="op">,</span> <span class="bu">std::</span>vector<span class="op">&lt;</span> Shape <span class="op">&gt;&amp;</span> a_shapes <span class="op">)</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="op">{</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>    <span class="kw">auto</span> DrawVisitor <span class="op">{</span> <span class="op">[&amp;</span>a_canvas<span class="op">](</span> <span class="kw">auto</span><span class="op">&amp;</span> shape <span class="op">)</span> <span class="op">{</span> draw<span class="op">(</span> a_canvas<span class="op">,</span> a_shape <span class="op">);</span> <span class="op">}</span> <span class="op">};</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="cf">for</span> <span class="op">(</span> <span class="kw">auto</span><span class="op">&amp;</span> shape <span class="op">:</span> a_shapes <span class="op">)</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>        <span class="bu">std::</span>visit<span class="op">(</span> DrawVisitor<span class="op">,</span> shape <span class="op">);</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="op">}</span></span></code></pre></div>
</div>

<div id="function-template" class="title-slide slide section level2"
number="2.8">
<h1><span class="header-section-number">2.8</span> Function
template</h1>
<ul>
<li>Basically a way to make it easy to add types</li>
<li>Comes with the cost that the types must support the same
interface</li>
<li>Comes with the cost that the function will be duplicated for each
type</li>
</ul>
</div>


<div id="task-distributed-tic-tac-toe"
class="title-slide slide section level1" number="3">
<h1><span class="header-section-number">3</span> Task: Distributed
Tic-Tac-Toe</h1>
<p>A lot of the systems we write are distributed, with several
executables cooperating to solve the task.</p>
<p>For this task the executables are going to be simulated in one
executable, for simplicity. We will simulate the communication in a way
that is similar to how this would look if there was separate
executables.</p>
<p>The system to design, and then implement is the game of Tic-Tac-Toe.
This is also known as Naughts and Crosses.</p>
</div>
<div id="rules-of-the-game" class="title-slide slide section level2"
number="3.1">
<h1><span class="header-section-number">3.1</span> Rules of the
game</h1>
<ul>
<li>There is a board of 3x3 squares</li>
<li>There are two players, denoted by their token X and O</li>
<li>The players take turn on placing their token on one square</li>
<li>The goal of the game is to get three in a row, horizontally,
vertically or diagonally</li>
<li>If a player succeeds in getting three in a row, that player wins the
game</li>
<li>If no player has three in a row when there are no more free squares,
the game is a draw</li>
</ul>
</div>

<div id="architecture" class="title-slide slide section level2"
number="3.2">
<h1><span class="header-section-number">3.2</span> Architecture</h1>
<ul>
<li>There needs to be a referee, that holds the board</li>
<li>The referee decides which player shall play next move</li>
<li>The referee checks for winner/draw after each move</li>
<li>Each player makes a move when allowed, only one move</li>
<li>There are two players, they do not talk to each other</li>
<li>Communication between the referee and the players will be done using
IntraCom</li>
<li>Tip: implement the game in a static library that is linked from a
driver executable</li>
</ul>
</div>

<div id="intracom-middleware" class="title-slide slide section level2"
number="3.3">
<h1><span class="header-section-number">3.3</span> IntraCom
middleware</h1>
<ul>
<li>This simplified middleware allows several components to send
messages to each other within one executable</li>
<li>It is a many to many communication</li>
<li>There are writers that sends data and readers that receives
data</li>
<li>All data sent by a writer can be read by all readers connected at
the time of sending</li>
<li>Data does not have a key, the same data can be sent several times,
all instances will be delivered to available readers</li>
<li>Data are automatically removed when all readers have received them,
readers are not notified</li>
</ul>
</div>
<div id="intracom-usage" class="slide section level3" number="3.3.1">
<h1><span class="header-section-number">3.3.1</span> IntraCom usage</h1>
<ul>
<li>There shall be a single instance of an IntraCom object, all objects
that are going to communicate must use this object</li>
<li>The IntraCom object can produce readers and writers for any copyable
type</li>
<li>Readers and writers are not shared between objects, but any number
of readers and writers for any type can be created</li>
<li>When a writer writes a message, this message is copied to a queue
where readers can get it</li>
<li>When a reader detects that there are data in the queue, it makes a
callback call with an argument that is a pointer to the reader</li>
<li>IntraCom has an internal thread, reader callbacks are made from this
thread</li>
<li>The callback must then check for which reader to read from, read all
the data and process them</li>
<li>A reader will not read the same data twice, so process all data when
it has data</li>
</ul>
</div>
<div id="intracom-example" class="slide section level3" number="3.3.2">
<h1><span class="header-section-number">3.3.2</span> IntraCom
example</h1>
<div class="sourceCode" id="cb11"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1"></a>   <span class="co">// In main()</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>   <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>       IntraCom<span class="op">::</span>IntraCom intracom<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>       Class obj<span class="op">(</span> <span class="op">&amp;</span>intracom <span class="op">);</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>       intracom<span class="op">.</span>start<span class="op">();</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>       <span class="co">// Wait for game to end</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>   <span class="op">}</span></span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>   <span class="co">// Class implementation</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>   Class<span class="op">::</span>Class<span class="op">(</span> IntraCom<span class="op">::</span>IntraCom<span class="op">*</span> a_intraCom<span class="op">)</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>       <span class="op">:</span> <span class="va">m_reader1</span> <span class="op">{</span> a_intraCom<span class="op">-&gt;</span>createReader<span class="op">&lt;</span> Msg1 <span class="op">&gt;(</span> <span class="op">[</span><span class="kw">this</span><span class="op">](</span> IntraCom<span class="op">::</span>Reader<span class="op">*</span> a_reader <span class="op">)</span> <span class="op">{</span> readData<span class="op">(</span> a_reader <span class="op">);</span> <span class="op">}</span> <span class="op">)</span> <span class="op">};</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>       <span class="op">,</span> <span class="va">m_reader2</span> <span class="op">{</span> a_intraCom<span class="op">-&gt;</span>createReader<span class="op">&lt;</span> Msg2 <span class="op">&gt;(</span> <span class="op">[</span><span class="kw">this</span><span class="op">](</span> IntraCom<span class="op">::</span>Reader<span class="op">*</span> a_reader <span class="op">)</span> <span class="op">{</span> readData<span class="op">(</span> a_reader <span class="op">);</span> <span class="op">}</span> <span class="op">)</span> <span class="op">};</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>       <span class="op">,</span> <span class="va">m_writer1</span> <span class="op">{</span> a_intraCom<span class="op">-&gt;</span>createWriter<span class="op">&lt;</span> Msg3 <span class="op">&gt;(</span> <span class="op">)</span> <span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>   <span class="op">{</span> </span>
<span id="cb11-15"><a href="#cb11-15"></a>       Msg3 sample<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>       <span class="co">// init sample</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>       <span class="va">m_writer1</span><span class="op">-&gt;</span>write<span class="op">(</span> sample <span class="op">);</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>   <span class="op">}</span></span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-20"><a href="#cb11-20"></a>   <span class="dt">void</span> Class<span class="op">::</span>readData<span class="op">(</span> IntraCom<span class="op">::</span>Reader<span class="op">*</span> a_reader <span class="op">)</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>   <span class="op">{</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>       <span class="cf">if</span> <span class="op">(</span> a_reader <span class="op">==</span> <span class="va">m_reader1</span> <span class="op">)</span></span>
<span id="cb11-23"><a href="#cb11-23"></a>       <span class="op">{</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>           <span class="cf">for</span> <span class="op">(</span> Msg1<span class="op">&amp;</span> sample <span class="op">:</span> <span class="va">m_reader1</span><span class="op">-&gt;</span>read<span class="op">()</span> <span class="op">)</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>               handleMsg1<span class="op">(</span> sample <span class="op">);</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>       <span class="op">}</span></span>
<span id="cb11-27"><a href="#cb11-27"></a>       <span class="cf">if</span> <span class="op">(</span> a_reader <span class="op">==</span> <span class="va">m_reader2</span> <span class="op">)</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>       <span class="op">{</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>           <span class="cf">for</span> <span class="op">(</span> Msg2<span class="op">&amp;</span> sample <span class="op">:</span> <span class="va">m_reader2</span><span class="op">-&gt;</span>read<span class="op">()</span> <span class="op">)</span></span>
<span id="cb11-30"><a href="#cb11-30"></a>               handleMsg2<span class="op">(</span> sample <span class="op">);</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>       <span class="op">}</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>   <span class="op">}</span></span></code></pre></div>
</div>

<div id="design-the-classes-and-data-types-this-game-needs"
class="title-slide slide section level2" number="3.4">
<h1><span class="header-section-number">3.4</span> Design the classes
and data types this game needs</h1>
<ul>
<li>Use OOP for the design</li>
<li>The players should have different strategies, but actual AI is not
needed, random and first available square is OK</li>
<li>The players should present themselves to the referee, and the
referee decides if their token is X or O</li>
<li>Once the players have presented themselves and received their tokens
the board is created and the game is on</li>
</ul>
</div>

<div id="one-possible-design" class="title-slide slide section level2"
number="3.5">
<h1><span class="header-section-number">3.5</span> One possible
design</h1>
<p>[TicTacToe_1]</p>
</div>

<div id="write-the-code" class="title-slide slide section level2"
number="3.6">
<h1><span class="header-section-number">3.6</span> Write the code</h1>
<ul>
<li>Remember that there must be some termination criteria</li>
<li>Create a reader in main() that sets a flag when the game is
finished</li>
<li>Since IntraCom operates in its own thread, main() can just sleep
until the flag is set</li>
</ul>
</div>

<div id="one-solution-for-the-possible-design"
class="title-slide slide section level2" number="3.7">
<h1><span class="header-section-number">3.7</span> One solution for the
possible design</h1>
<p>[TicTacToe_1]</p>
</div>

<div id="automatic-tests" class="title-slide slide section level2"
number="3.8">
<h1><span class="header-section-number">3.8</span> Automatic tests</h1>
<ul>
<li>You have tested the system manually by running it and observing the
behaviour</li>
<li>The code should have automatic tests to verify that it actually does
what we want</li>
<li>Add a test-project (BOOST test or Google test or whatever)</li>
<li>Add tests for each class and free function in the game</li>
<li>Do not modify the game code, that could introduce bugs</li>
</ul>
</div>

<div id="one-solution-to-tests-for-the-possible-design"
class="title-slide slide section level2" number="3.9">
<h1><span class="header-section-number">3.9</span> One solution to tests
for the possible design</h1>
<p>[TicTacToe_1]</p>
</div>


<div id="unit-tests" class="title-slide slide section level1"
number="4">
<h1><span class="header-section-number">4</span> Unit tests</h1>
<ul>
<li>Why have unit tests</li>
<li>How to write tests</li>
<li>How to make code testable</li>
<li>Speed of running translates to number of runs</li>
<li>The tests are part of the system</li>
<li>Other automatic tests</li>
</ul>
</div>
<div id="why-have-unit-tests" class="title-slide slide section level2"
number="4.1">
<h1><span class="header-section-number">4.1</span> Why have unit
tests</h1>
<ul>
<li>Make better design</li>
<li>Specify what should happen</li>
<li>Document how to use</li>
<li>Avoid debugger</li>
<li>Avoid starting application</li>
<li>Allow refactoring with confidence</li>
<li>Catch bugs</li>
<li>Faster development</li>
</ul>
</div>
<div id="make-better-design" class="slide section level3"
number="4.1.1">
<h1><span class="header-section-number">4.1.1</span> Make better
design</h1>
<ul>
<li>This works better if the tests drive the design, write tests
first</li>
<li>Encourages dependency injection</li>
<li>Encourages less dependencies</li>
</ul>
</div>
<div id="specify-what-should-happen" class="slide section level3"
number="4.1.2">
<h1><span class="header-section-number">4.1.2</span> Specify what should
happen</h1>
<ul>
<li>Test the requirements</li>
<li>Understand what the code should do, write tests to verify that it
does so</li>
</ul>
</div>
<div id="document-how-to-use" class="slide section level3"
number="4.1.3">
<h1><span class="header-section-number">4.1.3</span> Document how to
use</h1>
<ul>
<li>The tests basically documents how to use the unit, as that is what
they do</li>
<li>The tests do this by providing a lot of small examples</li>
</ul>
</div>
<div id="avoid-debugger" class="slide section level3" number="4.1.4">
<h1><span class="header-section-number">4.1.4</span> Avoid debugger</h1>
<ul>
<li>Starting the debugger takes longer than running the tests</li>
<li>Moving to the correct place/state takes even longer</li>
<li>Stepping through the code and checking the state is slow</li>
<li>Debug only when you cannot write tests to answer the question</li>
</ul>
</div>
<div id="avoid-starting-application" class="slide section level3"
number="4.1.5">
<h1><span class="header-section-number">4.1.5</span> Avoid starting
application</h1>
<ul>
<li>This is faster than the debugger, but provides less information</li>
<li>In some cases starting the application can take several minutes</li>
<li>When the application is started, it may take a while to maneuver to
where to test</li>
<li>You need to remember to test everything relevant</li>
</ul>
</div>
<div id="allow-refactoring-with-confidence" class="slide section level3"
number="4.1.6">
<h1><span class="header-section-number">4.1.6</span> Allow refactoring
with confidence</h1>
<ul>
<li>If something is broken, the tests will tell immediately</li>
<li>Most refactoring will be internal things, not affecting the
tests</li>
</ul>
</div>
<div id="catch-bugs" class="slide section level3" number="4.1.7">
<h1><span class="header-section-number">4.1.7</span> Catch bugs</h1>
<ul>
<li>Sometimes</li>
<li>Especially when modifying code later, and something unexpected
broke</li>
</ul>
</div>
<div id="faster-development" class="slide section level3"
number="4.1.8">
<h1><span class="header-section-number">4.1.8</span> Faster
development</h1>
<ul>
<li>Less time from coding to coding</li>
<li>Reducing this time wasted is an important factor in coding
speed</li>
<li>Theoretically could be immediate, but tools not there yet, at least
not for C++</li>
<li>Later in the project, the time to make changes will grow since there
is more potential for bugs due to unexpected sideeffects
<ul>
<li>Having unittests for all functionality makes this inefficiency grow
much slower</li>
<li>While it may seem like writing and maintaining all the tests slows
down development this does not happen in practice</li>
</ul></li>
</ul>
</div>

<div id="how-to-write-tests" class="title-slide slide section level2"
number="4.2">
<h1><span class="header-section-number">4.2</span> How to write
tests</h1>
<ul>
<li>Test one thing, if it fails it failed for one reason</li>
<li>Name the test according to what it tests, if it fails the name
basically tells you what is wrong</li>
<li>This makes for many testcases, which is a good thing</li>
<li>Test either a free function or a class’ behaviour, not a method</li>
<li>Group testcases logically</li>
<li>Only test the public interface of classes</li>
<li>Test corner cases as well as normal cases</li>
<li>Test error cases</li>
<li>Tests shall either succeed, every time, or fail, every time</li>
</ul>
</div>
<div id="test-one-thing-if-it-fails-it-failed-for-one-reason"
class="slide section level3" number="4.2.1">
<h1><span class="header-section-number">4.2.1</span> Test one thing, if
it fails it failed for one reason</h1>
<ul>
<li>If the test can fail for several reasons, more checking/debugging is
needed to pinpoint the problem if it fails</li>
<li>This should also keep the testcase small and easy to understand and
reason about</li>
</ul>
</div>
<div
id="name-the-test-according-to-what-it-tests-if-it-fails-the-name-basically-tells-you-what-is-wrong"
class="slide section level3" number="4.2.2">
<h1><span class="header-section-number">4.2.2</span> Name the test
according to what it tests, if it fails the name basically tells you
what is wrong</h1>
<ul>
<li>Ideally just seeing the name of the failed testcase should be enough
to know what is wrong</li>
</ul>
</div>
<div id="this-makes-for-many-testcases-which-is-a-good-thing"
class="slide section level3" number="4.2.3">
<h1><span class="header-section-number">4.2.3</span> This makes for many
testcases, which is a good thing</h1>
<ul>
<li>Thousands is good</li>
<li>Avoids the problem of forgetting to test everything manually (just
changed this, so only need to test that, missing sideeffects)</li>
<li>Requires that each case runs fast</li>
</ul>
</div>
<div id="test-either-a-free-function-or-a-class-behaviour-not-a-method"
class="slide section level3" number="4.2.4">
<h1><span class="header-section-number">4.2.4</span> Test either a free
function or a class’ behaviour, not a method</h1>
<ul>
<li>Testing free functions is easy, call them with different arguments
and check the return value</li>
<li>Free functions may have more effects than this, but strive for pure
functions to avoid spooky action functions</li>
<li>If there are free functions that come from external API, encapsulate
them in a IO or business logic type class with an interface so that they
can be stubbed out when testing client code</li>
<li>Classes are tested by behaviour
<ul>
<li>A new X is empty, create an X and check that X.empty() == true</li>
<li>A new X has no elements, create an X and check that X.begin() ==
X.end()</li>
<li>A new X has zero size, create an X and check that X.size() == 0</li>
</ul></li>
</ul>
</div>
<div id="group-testcases-logically" class="slide section level3"
number="4.2.5">
<h1><span class="header-section-number">4.2.5</span> Group testcases
logically</h1>
<ul>
<li>This makes them easier to read and manage mentally</li>
<li>XTest/AfterCreation/is_empty</li>
<li>XTest/AfterCreation/has_no_elements</li>
<li>XTest/AfterCreation/has_zero_size</li>
</ul>
</div>
<div id="only-test-the-public-interface-of-classes"
class="slide section level3" number="4.2.6">
<h1><span class="header-section-number">4.2.6</span> Only test the
public interface of classes</h1>
<ul>
<li>Internal state is just an implementation detail, and can change</li>
<li>Implementation details should be open to complete rewrite without
affecting tests</li>
<li>Private methods that need tests should be considered refactored into
free functions</li>
<li>Looking at internal state for a testcase is not OK</li>
</ul>
</div>
<div id="test-corner-cases-as-well-as-normal-cases"
class="slide section level3" number="4.2.7">
<h1><span class="header-section-number">4.2.7</span> Test corner cases
as well as normal cases</h1>
<ul>
<li>If the range of valid input is 1-10, test 0, 1, 10, 11</li>
<li>Make the tests go through all paths
<ul>
<li>Even complex boolean expressions where short-circuiting creates a
lot of paths</li>
</ul></li>
<li>Make sure you test all legal combinations of input/state
<ul>
<li>Not necessary to test all values, just examples of valid/invalid
values</li>
</ul></li>
</ul>
</div>
<div id="test-error-cases" class="slide section level3" number="4.2.8">
<h1><span class="header-section-number">4.2.8</span> Test error
cases</h1>
<ul>
<li>Exercise the error handling
<ul>
<li>This may be the only time it is run before deployment, there could
be a crash in there even if it compiles</li>
</ul></li>
<li>Check that nothing is produced if nothing should be produced
<ul>
<li>Much easier and faster in unittests than manual testing</li>
</ul></li>
</ul>
</div>
<div id="tests-shall-either-succeed-every-time-or-fail-every-time"
class="slide section level3" number="4.2.9">
<h1><span class="header-section-number">4.2.9</span> Tests shall either
succeed, every time, or fail, every time</h1>
<ul>
<li>Do not let tests fail sometimes, it is a sign of bad code
design</li>
<li>Tests that are unstable are hard to know when are fixed</li>
<li>Tests that fail makes the developers insensitive and indifferent to
the tests, so always make sure that the tests are OK</li>
</ul>
</div>

<div id="how-to-make-code-testable"
class="title-slide slide section level2" number="4.3">
<h1><span class="header-section-number">4.3</span> How to make code
testable</h1>
<ul>
<li>Separate concerns into separate entities</li>
<li>Inject dependencies</li>
<li>No global/static/singleton data unless actually constant over all
runs</li>
</ul>
</div>
<div id="separate-concerns-into-separate-entities"
class="slide section level3" number="4.3.1">
<h1><span class="header-section-number">4.3.1</span> Separate concerns
into separate entities</h1>
<ul>
<li>Code not really part of the class/function should be separated and
tested separately
<ul>
<li>Do not make the God-object type of code</li>
<li>Smaller units are easier to understand</li>
<li>Units that handle a specific area of concern are easier to
reuse</li>
</ul></li>
<li>IO, time and timers are separate entities from the class under test
<ul>
<li>These tend to make testing slow or difficult if embedded</li>
<li>IO shall always be behind an interface</li>
<li>Time shall be provided from the outside to units that need it</li>
<li>Timers shall be external to the unit, and just call a method, pass
an argument that can be used to know how much time has passed</li>
<li>Doing this should provide a unit that can be tested with no
delays</li>
<li>Doing this also allows for fast negative test, where no result is
produced</li>
</ul></li>
</ul>
</div>
<div id="inject-dependencies" class="slide section level3"
number="4.3.2">
<h1><span class="header-section-number">4.3.2</span> Inject
dependencies</h1>
<ul>
<li>This allows for faster tests</li>
<li>Also easy test of dependency usage</li>
<li>Allows faking errors so that error handling code is also tested</li>
<li>Better design in general</li>
</ul>
</div>
<div
id="no-globalstaticsingleton-data-unless-actually-constant-over-all-runs"
class="slide section level3" number="4.3.3">
<h1><span class="header-section-number">4.3.3</span> No
global/static/singleton data unless actually constant over all runs</h1>
<ul>
<li>These make testcases talk to eachother
<ul>
<li>This makes the order of testcases important</li>
<li>This makes running testcases in parallel impossible</li>
</ul></li>
<li>They make for weird and hard to find bugs (access order
dependencies)</li>
<li>Code becomes hard to reason about since there can be spooky action
at a distance</li>
</ul>
</div>

<div id="speed-of-running-translates-to-number-of-runs"
class="title-slide slide section level2" number="4.4">
<h1><span class="header-section-number">4.4</span> Speed of running
translates to number of runs</h1>
<ul>
<li>Tests should run in &lt; 1ms per testcase
<ul>
<li>Expect the number of testcases to grow throughout the life of the
application</li>
</ul></li>
<li>Tests should be independent of other tests (order of execution)
<ul>
<li>Then they can run in parallel, which increases performance for each
new core used</li>
</ul></li>
<li>There should be many (hundreds or thousands) of testcases for medium
sized projects
<ul>
<li>There should eventually be thousands of cases, maybe hundred
thousands for larger applications</li>
<li>Running the tests shall not feel like waste of time</li>
</ul></li>
<li>Tests should ideally be part of the normal build (a buildstep)
<ul>
<li>Failing tests are bugs found before starting application -&gt; Big
win</li>
<li>Even better if they can be part of the editor and run in realtime
while typing, but tools not there yet</li>
</ul></li>
</ul>
</div>

<div id="the-tests-are-part-of-the-system"
class="title-slide slide section level2" number="4.5">
<h1><span class="header-section-number">4.5</span> The tests are part of
the system</h1>
<ul>
<li>Not an afterthought
<ul>
<li>Writing tests after the code encourages code to be hard to test and
tests to be hard to write</li>
</ul></li>
<li>Best practice is to write test before production code
<ul>
<li>Only write code that is tested</li>
<li>Make the test fail, and check that it does, before writing the
production code so that it tests what it should</li>
</ul></li>
<li>Must be maintained with the rest of the code
<ul>
<li>As requirements of the code changes, the functionality changes, and
therefore the tests</li>
<li>If tests are not maintained, the benefits are quickly lost and code
degrades</li>
</ul></li>
</ul>
</div>

<div id="other-automatic-tests" class="title-slide slide section level2"
number="4.6">
<h1><span class="header-section-number">4.6</span> Other automatic
tests</h1>
<ul>
<li>Component tests</li>
<li>System tests</li>
<li>All tests shall be minimal to check what needs to be checked at this
level</li>
</ul>
</div>
<div id="component-tests" class="slide section level3" number="4.6.1">
<h1><span class="header-section-number">4.6.1</span> Component
tests</h1>
<ul>
<li>These test full subsystems/components</li>
<li>Can test several configurations of the component</li>
<li>Tests simulate the part of the system needed by the component
<ul>
<li>Other components this component communicates with</li>
<li>May also include external systems</li>
<li>May also include hardware</li>
<li>May also include users</li>
</ul></li>
<li>If the unit tests are very good, the component tests are basically
checking if all wiring between units is in place</li>
<li>Negative testing (where no result shall be produced) shall be done
in unit tests</li>
<li>Error testing (where errors shall be produced) shall be done in unit
tests</li>
</ul>
</div>
<div id="system-tests" class="slide section level3" number="4.6.2">
<h1><span class="header-section-number">4.6.2</span> System tests</h1>
<ul>
<li>These test the full system</li>
<li>Can test several configurations of the system</li>
<li>Tests simulate the external agents to the system
<ul>
<li>External systems</li>
<li>Hardware</li>
<li>Users</li>
</ul></li>
<li>If the unit tests are very good, the system tests are basically
checking if all wiring between components is in place</li>
</ul>
</div>
<div
id="all-tests-shall-be-minimal-to-check-what-needs-to-be-checked-at-this-level"
class="slide section level3" number="4.6.3">
<h1><span class="header-section-number">4.6.3</span> All tests shall be
minimal to check what needs to be checked at this level</h1>
<ul>
<li>This means that large scale tests do not check what smaller scale
tests have checked</li>
<li>Unit tests checks all the details of the unit, including quality and
error handling</li>
<li>Component tests checks that units talk OK with eachother</li>
<li>System tests checks that components talk OK with eachother</li>
<li>This allows the tests to be easy to maintain</li>
<li>This allows the tests to run fast</li>
</ul>
</div>


<div id="data-holders" class="title-slide slide section level1"
number="5">
<h1><span class="header-section-number">5</span> Data holders</h1>
<ul>
<li>These are the classes that hold the data and important state of your
application</li>
<li>Keeping these as separate objects allows them to be easily shared
between components and applications</li>
<li>This allows for simpler communication</li>
<li>They also say a lot about what the application does</li>
</ul>
</div>
<div id="struct-vs-class" class="title-slide slide section level2"
number="5.1">
<h1><span class="header-section-number">5.1</span> struct vs class</h1>
<ul>
<li>The difference is spelling and intent</li>
<li>And default access level
<ul>
<li>struct is default public</li>
<li>class is default private</li>
</ul></li>
</ul>
</div>
<div id="struct" class="slide section level3" number="5.1.1">
<h1><span class="header-section-number">5.1.1</span> struct</h1>
<ul>
<li>In a struct the expectation is that is can be treated as a
collection of fields that are independant and can be modified at
will</li>
<li>All fields are public, and the struct will not contain any methods,
unless constructors are needed by members to ensure legal default
values</li>
<li>The fields are not dependant on eachother</li>
<li>Each field can receive the full range of values for its type</li>
<li>Thus, no combination of values are actually illegal</li>
<li>They may be wrong, but the system should handle any combination
gracefully</li>
</ul>
</div>
<div id="class" class="slide section level3" number="5.1.2">
<h1><span class="header-section-number">5.1.2</span> class</h1>
<ul>
<li>In a class the expectation is that it has a limited set of legal
values, and this is enforced by the class: invariant</li>
<li>No fields are public, and the class will contain the methods needed
to ensure the fields are always valid</li>
<li>The fields depend on eachother and can often not be set
independently of eachother</li>
<li>The class object can only hold a subset of the range of its members’
ranges</li>
<li>Many, usually most, of the potential values are illegal and
prohibited by the class</li>
<li>Therefore the class objects should never be in an illegal state
<ul>
<li>Error states can be valid states, but should be avoided for most
types</li>
</ul></li>
</ul>
</div>
<div id="enum" class="slide section level3" number="5.1.3">
<h1><span class="header-section-number">5.1.3</span> enum</h1>
<ul>
<li>An enum is a set of names where the value can be any one of those
values</li>
<li>Useful for discriminating between states/types</li>
<li>Useful for giving names to different values of a type with a small
set of legal values</li>
<li>No fields, methods or operators</li>
<li>Can be argument in free functions and free operators</li>
<li>Strictly speaking, any type in a computer can be represented by an
enum</li>
</ul>
</div>
<div id="union" class="slide section level3" number="5.1.4">
<h1><span class="header-section-number">5.1.4</span> union</h1>
<ul>
<li>Old mechanism from C</li>
<li>Does not help with types</li>
<li>Needs some form of discriminant to be useful</li>
<li>Needs a bit of supporting code to be correct, especially with
regards to object lifetime</li>
<li>Basically obsolete, use std::variant instead, which has all the
supporting code to be safe to use</li>
</ul>
</div>

<div id="minimal-but-complete" class="title-slide slide section level2"
number="5.2">
<h1><span class="header-section-number">5.2</span> Minimal but
complete</h1>

</div>
<div id="the-class-interface-should-not-be-larger-than-necessary"
class="slide section level3" number="5.2.1">
<h1><span class="header-section-number">5.2.1</span> The class interface
should not be larger than necessary</h1>
<ul>
<li>Only provide the methods that are needed to operate the object in
the application</li>
<li>Give a complete interface, so that all basic actions can be
performed
<ul>
<li>This does not include convenience methods</li>
<li>This does include all methods to access functionality</li>
<li>Typically getters and setters of fields are problematic for keeping
the invariant
<ul>
<li>Must not give clients the ability to set the object in an invalid
state</li>
<li>They also tend to expose the internal implementation, thus breaking
encapsulation</li>
</ul></li>
</ul></li>
<li>Extra functionality should be outside the class
<ul>
<li>C++ is a multi-paradigm language</li>
<li>Free functions are legal and good</li>
</ul></li>
</ul>
</div>
<div id="there-should-not-be-more-data-than-necessary"
class="slide section level3" number="5.2.2">
<h1><span class="header-section-number">5.2.2</span> There should not be
more data than necessary</h1>
<ul>
<li>For some objects it may be desirable to cache some calculations,
this is OK</li>
<li>Do not hold data that can be easily calculated from other data</li>
<li>Do not hold data that couples the object to other objects that are
actually external, do not force a data structure that is not naturally a
part of the object</li>
<li>For objects that will exist in large numbers, rember that most
fields will have a very limited range of legal values, consider using
enums…</li>
</ul>
</div>

<div id="copy-and-move-special-functions"
class="title-slide slide section level2" number="5.3">
<h1><span class="header-section-number">5.3</span> Copy and move special
functions</h1>
<ul>
<li>Data holders should support copy and move operations
<ul>
<li>These objects are often created in large numbers, copied around and
generally used a lot</li>
<li>They may also be stored by value in collections, which may need to
reallocate</li>
</ul></li>
</ul>
</div>

<div id="value-semantics" class="title-slide slide section level2"
number="5.4">
<h1><span class="header-section-number">5.4</span> Value semantics</h1>

</div>
<div
id="these-objects-should-be-similar-to-int-string-vector-type-objects"
class="slide section level3" number="5.4.1">
<h1><span class="header-section-number">5.4.1</span> These objects
should be similar to int, string, vector type objects</h1>
<ul>
<li>This does not include overloading all operators, only those that
make sense for the type</li>
<li>The uses for these objects is that they hold some data, this is the
same as e.g. int</li>
<li>Objects will often be held on stack, or as parts of other
objects</li>
</ul>
</div>
<div id="constructors" class="slide section level3" number="5.4.2">
<h1><span class="header-section-number">5.4.2</span> Constructors</h1>
<ul>
<li>These classes should have copy and move constructors
<ul>
<li>The compiler generated ones should be OK</li>
<li>If a destructor is included, these constructors should be
implemented</li>
</ul></li>
<li>These classes probably should have a default constructor
<ul>
<li>This might not be OK for all, but for most</li>
<li>Omitting a default constructor can cause usage-problems for
collections</li>
</ul></li>
<li>These classes probably should have some constructors for setting a
proper value
<ul>
<li>There might be only one, for simple classes</li>
<li>There may be several, if there are several ways to construct a valid
object</li>
</ul></li>
<li>Constructors that fail to construct a valid object should prefer to
throw
<ul>
<li>This makes it impossible to construct an invalid object</li>
<li>Setting some error-state and carrying on leaves a burden on the user
of the class</li>
<li>Consider making some “will this work” type check available. This may
be just documenting that the exception is possible</li>
</ul></li>
<li>If several ways to create an object from the same types are needed,
use static methods
<ul>
<li>Then these can perform the necessary operations to make a valid
object</li>
<li>They might call a private constructor</li>
</ul></li>
</ul>
</div>
<div id="operators" class="slide section level3" number="5.4.3">
<h1><span class="header-section-number">5.4.3</span> Operators</h1>
<ul>
<li>These classes should have copy and move assignment operators
<ul>
<li>The compiler generated ones should be OK</li>
<li>If a destructor is included, these operators should be
implemented</li>
</ul></li>
<li>Other operators can be added, follow the general expectation for
what they should do
<ul>
<li>For symmetric operators, make them free functions</li>
<li>Most operators should be implementable as free functions</li>
</ul></li>
</ul>
</div>
<div id="methods" class="slide section level3" number="5.4.4">
<h1><span class="header-section-number">5.4.4</span> Methods</h1>
<ul>
<li>These classes should have methods for basic manipulation</li>
<li>A good set of methods will make it relatively easy to make
convenience functions as free functions</li>
<li>A good set of methods do not have overlapping responsabilities</li>
<li>Methods should prefer to throw rather than allowing an invalid
object to exist</li>
<li>Methods may return an error rather than throwing, but still not
allow invalid object to exist</li>
</ul>
</div>
<div id="destructor" class="slide section level3" number="5.4.5">
<h1><span class="header-section-number">5.4.5</span> Destructor</h1>
<ul>
<li>Only add this if needed</li>
<li>Design data holder classes primarily so that the destructor is not
needed
<ul>
<li>Thus the compiler generated is OK</li>
<li>Sometimes it is advisable to add a destructor so that the compiler
does NOT inline it
<ul>
<li>It should then be = default in the cpp file</li>
<li>This happens when the destructor is large and/or inlined a lot of
places</li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="field-order" class="title-slide slide section level2"
number="5.5">
<h1><span class="header-section-number">5.5</span> Field order</h1>
<ul>
<li>To avoid wasting a lot of space in the object, some care must be
taken</li>
<li>Data holder objects will often be held in collections, and size of
the object is important for performance</li>
<li>Do not use larger fields than needed
<ul>
<li>If an int is enough for the data, do not use a string</li>
<li>Most data types will have a very limited range, so a smaller data
type can be used, maybe enum, maybe some integer that is an index into a
table</li>
<li>This should not be a problem, as the inner representation should not
be visible outside class</li>
<li>For some objects the extra computation to translate from a small
representation to an actual value is less then the extra time needed to
fetch more cache lines</li>
</ul></li>
<li>Order the fields by alignment
<ul>
<li>This typically means by size
<ul>
<li>At least for 1-8 byte fields</li>
<li>Enums can have several sizes, unless specified at declaration, this
is compiler dependant</li>
<li>Allocated size is not included in size (this is on the heap)</li>
<li>Arrays are aligned the same as the elements</li>
<li>Composite fields (classes and structs) are aligned by largest
alignment field</li>
</ul></li>
<li>Order the fields so that the larger alignment fields are first, and
then smaller and smaller
<ul>
<li>This can, in some cases, allow for using inheritance to add fields
without increasing object size</li>
</ul></li>
<li>For some objects proper ordering of fields can drastically reduce
the memory requirements</li>
</ul></li>
</ul>
</div>

<div id="typical-data-holders" class="title-slide slide section level2"
number="5.6">
<h1><span class="header-section-number">5.6</span> Typical data
holders</h1>
<ul>
<li>Business objects, that hold data flowing through the
application</li>
<li>Collections of objects</li>
<li>Objects that are parts of business objects</li>
</ul>
</div>

<div id="example" class="title-slide slide section level2" number="5.7">
<h1><span class="header-section-number">5.7</span> Example</h1>
<ul>
<li>Circle</li>
<li>Employee</li>
</ul>
</div>

<div id="task-1" class="title-slide slide section level2" number="5.8">
<h1><span class="header-section-number">5.8</span> Task</h1>
<ul>
<li>Look at the TicTacToe code and try to identify DataHolder
objects</li>
<li>Can they be improved?</li>
<li>If so, how?</li>
<li>Try making one of the DataHolder objects into a proper
DataHolder</li>
<li>Add automatic tests for it</li>
</ul>
</div>


<div id="io-classes" class="title-slide slide section level1"
number="6">
<h1><span class="header-section-number">6</span> IO classes</h1>
<ul>
<li>These are the classes that implement the IO functionality of the
system</li>
<li>Keeping these as separate objects allows them to be easily shared
between components and applications</li>
<li>IO should not really be considered part of the business of the
application, even though it is very important</li>
<li>IO should only be concerned with getting data into the application
and sending data out from the application</li>
</ul>
</div>
<div id="io-classes-shall-always-implement-some-interface"
class="title-slide slide section level2" number="6.1">
<h1><span class="header-section-number">6.1</span> IO classes shall
always implement some interface</h1>
<ul>
<li>There shall always be at least two implementations, the program’s
implementation and the test’s implementation</li>
<li>This is probably one of the most efficient ways to make writing
tests easy and efficient</li>
<li>This also opens up the possibility to easily change the way the
application does IO</li>
</ul>
</div>

<div id="reference-semantics" class="title-slide slide section level2"
number="6.2">
<h1><span class="header-section-number">6.2</span> Reference
semantics</h1>

</div>
<div id="these-classes-should-not-be-like-ints-or-strings"
class="slide section level3" number="6.2.1">
<h1><span class="header-section-number">6.2.1</span> These classes
should not be like ints or strings</h1>
<ul>
<li>The typical use for these objects are create one and keep it for the
duration of the program. They are usually sent to and used by business
logic classes</li>
<li>Any class/function that needs these objects shall receive a
reference or pointer to the interface of the IO type</li>
<li>Sometimes there need to be several of one of these (they may need to
have some different settings), but this should be avoided, keep such
state in a data holder instead</li>
<li>Some state/dependencies may be needed/desired for ease of use,
typically ResourceManagers for files/sockets/etc</li>
</ul>
</div>
<div id="constructors-1" class="slide section level3" number="6.2.2">
<h1><span class="header-section-number">6.2.2</span> Constructors</h1>
<ul>
<li>These object should have one or more constructors that sets up the
different ways to create the object</li>
<li>Copy/default constructors are not wanted. Sometimes move contructor
can be used. These objects do not copy naturally, but in a few cases
they may move</li>
<li>Constructors that fail to construct a valid object should prefer to
throw
<ul>
<li>This makes it impossible to construct an invalid object</li>
<li>No invalid object means the IO is at least theoretically
possible</li>
</ul></li>
</ul>
</div>
<div id="operators-1" class="slide section level3" number="6.2.3">
<h1><span class="header-section-number">6.2.3</span> Operators</h1>
<ul>
<li>No operators needed</li>
<li>But sometimes they can help with readability, like insert and
extract operators for streams</li>
<li>Delete the copy assignment operator (and usually move assignment),
as they make no sense</li>
</ul>
</div>
<div id="methods-1" class="slide section level3" number="6.2.4">
<h1><span class="header-section-number">6.2.4</span> Methods</h1>
<ul>
<li>All methods should be public</li>
<li>These classes shall always implement an interface, only the
interface shall be used by client code</li>
<li>In the case of errors, either an error is returned or an exception
is thrown. This is part of the interface, and shall be documented there.
Do not mix these for any interface implementation.</li>
<li>All methods not part of the interface are for
setup/teardown/diagnostics only</li>
</ul>
</div>
<div id="destructor-1" class="slide section level3" number="6.2.5">
<h1><span class="header-section-number">6.2.5</span> Destructor</h1>
<ul>
<li>Add a virtual destructor, should probably be = default in the
cpp-file.</li>
<li>These objects are often used in some polymorphic context</li>
<li>Since any cleanup needed shall be handled by a ResourceManager type,
this is not needed in the IO-class destructor</li>
</ul>
</div>

<div id="typical-io-classes" class="title-slide slide section level2"
number="6.3">
<h1><span class="header-section-number">6.3</span> Typical IO
classes</h1>
<ul>
<li>Database connections</li>
<li>Network connections</li>
<li>File IO</li>
<li>DDS readers and writers</li>
<li>Test IO, very useful for unit tests</li>
</ul>
</div>

<div id="example-1" class="title-slide slide section level2"
number="6.4">
<h1><span class="header-section-number">6.4</span> Example</h1>
<ul>
<li>Publishing data through DDS data writer</li>
<li>Receiving data from file</li>
</ul>
</div>

<div id="task-2" class="title-slide slide section level2" number="6.5">
<h1><span class="header-section-number">6.5</span> Task</h1>
<ul>
<li>Look at the TicTacToe code and try to identify IO objects</li>
<li>Can their use be improved?</li>
<li>If so, how?</li>
<li>Try making the IO objects into proper IO class(es), with useful
interfaces</li>
<li>Change the automatic tests to take advantage of this</li>
</ul>
</div>

<div id="section" class="title-slide slide section level2" number="6.6">
<h1><span class="header-section-number">6.6</span>
<Provide a suggested solution></h1>

</div>


<div id="business-logic" class="title-slide slide section level1"
number="7">
<h1><span class="header-section-number">7</span> Business logic</h1>
<ul>
<li>This is where the program converts/processes data</li>
</ul>
</div>
<div id="reference-semantics-1" class="title-slide slide section level2"
number="7.1">
<h1><span class="header-section-number">7.1</span> Reference
semantics</h1>

</div>
<div id="these-classes-should-not-be-like-ints-or-strings-1"
class="slide section level3" number="7.1.1">
<h1><span class="header-section-number">7.1.1</span> These classes
should not be like ints or strings</h1>
<ul>
<li>The typical use for these objects is create one and keep it for the
duration of the program</li>
<li>Any class/function that needs these objects shall receive a
reference or pointer to one</li>
<li>Sometimes there need to be several of one of these (they may need to
have some different settings), but this should be avoided, keep such
state in a data holder instead</li>
<li>Some dependencies may be needed/desired for ease of use, typically
IO-interfaces</li>
<li>Some state-references (or pointers) may be needed to know which data
to operate on for callbacks</li>
</ul>
</div>
<div id="constructors-2" class="slide section level3" number="7.1.2">
<h1><span class="header-section-number">7.1.2</span> Constructors</h1>
<ul>
<li>These object should have a single constructor that accepts all
arguments needed to operate</li>
<li>Copy/move/default constructors are not wanted. These objects do not
copy or move naturally</li>
<li>Normally the constructors of these objects do not fail, any failure
happens before calling the constructor (fail to create the
dependencies)</li>
</ul>
</div>
<div id="operators-2" class="slide section level3" number="7.1.3">
<h1><span class="header-section-number">7.1.3</span> Operators</h1>
<ul>
<li>No operators needed</li>
<li>Delete the assignment operators (copy and move), as they make no
sense</li>
</ul>
</div>
<div id="methods-2" class="slide section level3" number="7.1.4">
<h1><span class="header-section-number">7.1.4</span> Methods</h1>
<ul>
<li>All methods should be public, and take in the needed arguments for
each call</li>
<li>Sometimes private methods are useful, but consider making them free
functions</li>
<li>Some of the methods may be virtual, these classes can use
inheritance to reuse code</li>
<li>The class may implement some interface(s), these classes can be
reused by other business logic classes or functions</li>
</ul>
</div>
<div id="destructor-2" class="slide section level3" number="7.1.5">
<h1><span class="header-section-number">7.1.5</span> Destructor</h1>
<ul>
<li>Since some polymorphic use of these classes are likely, add a
virtual destructor</li>
</ul>
</div>

<div id="typical-business-classes"
class="title-slide slide section level2" number="7.2">
<h1><span class="header-section-number">7.2</span> Typical business
classes</h1>
<ul>
<li>Visitor pattern functions</li>
<li>Data manipulation classes</li>
<li>Consider free functions, they may be enough</li>
</ul>
</div>

<div id="example-2" class="title-slide slide section level2"
number="7.3">
<h1><span class="header-section-number">7.3</span> Example</h1>
<ul>
<li>A visitor class for drawing</li>
<li>A simple Employee transforming class
<ul>
<li>Create</li>
<li>Update salary</li>
<li>Change address</li>
</ul></li>
</ul>
</div>

<div id="task-3" class="title-slide slide section level2" number="7.4">
<h1><span class="header-section-number">7.4</span> Task</h1>
<ul>
<li>Look at the TicTacToe code and try to identify BusinessLogic
objects</li>
<li>Can their design be improved?</li>
<li>If so, how?</li>
<li>Try making the BusinessLogic objects into proper BusinessLogic
class(es) and/or free functions</li>
<li>Change the automatic tests to take advantage of this</li>
</ul>
</div>

<div id="section-1" class="title-slide slide section level2"
number="7.5">
<h1><span class="header-section-number">7.5</span>
<Provide a suggested solution></h1>

</div>


<div id="resource-managers" class="title-slide slide section level1"
number="8">
<h1><span class="header-section-number">8</span> Resource managers</h1>
<p>These objects are used to ensure that resource management is done
properly and that resources are released when no longer needed This is
RAII, Resource Acquisition Is Initialization</p>
</div>
<div id="value-semantics-1" class="title-slide slide section level2"
number="8.1">
<h1><span class="header-section-number">8.1</span> Value semantics</h1>

</div>
<div
id="these-objects-might-have-similarities-with-int-string-vector-type-objects"
class="slide section level3" number="8.1.1">
<h1><span class="header-section-number">8.1.1</span> These objects might
have similarities with int, string, vector type objects</h1>
<ul>
<li>This does not include overloading operators</li>
</ul>
</div>
<div id="constructors-3" class="slide section level3" number="8.1.2">
<h1><span class="header-section-number">8.1.2</span> Constructors</h1>
<ul>
<li>These classes should have copy and/or move constructors, depending
on desired semantics
<ul>
<li>The compiler generated ones are probably not OK</li>
<li>Those not wanted shall be “= delete”</li>
</ul></li>
<li>These classes might have a default constructor
<ul>
<li>If so, it should set the state of the object to some form of “no
resource currently owned”</li>
<li>It would also need some method for taking ownership over a resource
<ul>
<li>Such a method must properly handle the release of previously owned
resources</li>
</ul></li>
</ul></li>
<li>These classes should have some constructors for setting a proper
value
<ul>
<li>There might be only one
<ul>
<li>This takes ownership of a resource of the correct type</li>
<li>This is used when old APIs are used to create the resource</li>
</ul></li>
<li>There may be several, if there are several ways to construct a valid
resource</li>
</ul></li>
<li>Constructors should not fail to construct a valid object
<ul>
<li>This makes it impossible to construct an invalid object</li>
<li>There should not be a way to fail this, it might lead to an empty
object though</li>
</ul></li>
</ul>
</div>
<div id="operators-3" class="slide section level3" number="8.1.3">
<h1><span class="header-section-number">8.1.3</span> Operators</h1>
<ul>
<li>These classes might have copy and/or move assignment operators,
<ul>
<li>Same as the constructors</li>
<li>The compiler generated ones are not OK</li>
</ul></li>
<li>Other operators should be avoided
<ul>
<li>Unless they make sense, like operator* and operator-&gt; for
pointer-like classes</li>
</ul></li>
</ul>
</div>
<div id="methods-3" class="slide section level3" number="8.1.4">
<h1><span class="header-section-number">8.1.4</span> Methods</h1>
<ul>
<li>These classes should have methods for basic manipulation
<ul>
<li>Resetting the resource under control (probably)</li>
<li>Clearing the resource under control (possibly)</li>
<li>Getting access to the resource under control (probably) to allow the
use of existing APIs</li>
</ul></li>
<li>Methods should not allow an invalid object to exist
<ul>
<li>Managed resource may be in an error state though</li>
</ul></li>
</ul>
</div>
<div id="destructor-3" class="slide section level3" number="8.1.5">
<h1><span class="header-section-number">8.1.5</span> Destructor</h1>
<ul>
<li>This is maybe the most important method of the class</li>
<li>Not virtual, these objects are not meant to be inherited</li>
<li>Releases the resource, if still held</li>
</ul>
</div>

<div id="typical-resource-managers"
class="title-slide slide section level2" number="8.2">
<h1><span class="header-section-number">8.2</span> Typical resource
managers</h1>
<ul>
<li>Objects owning memory</li>
<li>Objects owning files</li>
<li>Objects owning database connections</li>
</ul>
</div>

<div id="non-typical-resource-managers-that-maybe-should-be-typical"
class="title-slide slide section level2" number="8.3">
<h1><span class="header-section-number">8.3</span> Non-typical resource
managers that maybe should be typical</h1>
<ul>
<li>Objects owning operations that should always be performed at the end
of scope
<ul>
<li>Since the general idea of these objects are the destructor, they can
in fact be used to assure some operation is performed at the end of
scope
<ul>
<li>This can eliminate the need to check if a value is set or a flag at
the end of the scope</li>
<li>Will also be exception safe</li>
<li>Can actually check if reached because of exception or normal
flow</li>
<li>Check Andrei at CppCon…</li>
</ul></li>
</ul></li>
<li>Objects owning access to another object
<ul>
<li>locked_ptr (not standard, make your own)</li>
</ul></li>
</ul>
</div>

<div id="example-3" class="title-slide slide section level2"
number="8.4">
<h1><span class="header-section-number">8.4</span> Example</h1>
<ul>
<li>std::unique_ptr (memory, only moveable)</li>
<li>std::shared_ptr (memory, move and copy)</li>
<li>std::ifstream (file, only moveable)</li>
<li>std::lock_guard (mutex-lock, neither move nor copy)</li>
</ul>
</div>

<div id="task-4" class="title-slide slide section level2" number="8.5">
<h1><span class="header-section-number">8.5</span> Task</h1>
<pre><code>TODO: come up with some useful task</code></pre>
</div>

<div id="provide-a-suggested-solution"
class="title-slide slide section level2" number="8.6">
<h1><span class="header-section-number">8.6</span> Provide a suggested
solution</h1>

</div>


<div id="functionmethod-design" class="title-slide slide section level1"
number="9">
<h1><span class="header-section-number">9</span> Function/method
design</h1>

</div>
<div id="naming" class="title-slide slide section level2" number="9.1">
<h1><span class="header-section-number">9.1</span> Naming</h1>
<ul>
<li>Naming things is hard but important</li>
<li>Functions should do one thing and be named accordingly</li>
<li>Name functions for what they do, not how</li>
</ul>
<div class="sourceCode" id="cb13"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">// Good</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">auto</span> radiansFromDegrees<span class="op">(</span> <span class="dt">double</span> degrees <span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">auto</span> pythagoras<span class="op">(</span> <span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> y<span class="op">,</span> <span class="dt">double</span> z <span class="op">);</span></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">// Bad</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">auto</span> to_radians<span class="op">(</span> <span class="dt">double</span> degrees <span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="kw">auto</span> rootOfSumOfSquares<span class="op">(</span> <span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> y<span class="op">,</span> <span class="dt">double</span> z <span class="op">);</span></span></code></pre></div>
</div>

<div id="type" class="title-slide slide section level2" number="9.2">
<h1><span class="header-section-number">9.2</span> Type</h1>
<ul>
<li>The type of a function is composed of the argument types and the
return type</li>
<li>The type of a method also contains the class</li>
<li>When the type of the function is good, it does tell a lot about the
function</li>
</ul>
<div class="sourceCode" id="cb14"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">auto</span> funcA<span class="op">(</span> function<span class="op">&lt;</span> B<span class="op">(</span><span class="at">const</span> A<span class="op">&amp;)</span> <span class="op">&gt;,</span> <span class="at">const</span> vector<span class="op">&lt;</span> A <span class="op">&gt;&amp;</span> <span class="op">)</span> <span class="op">-&gt;</span> vector<span class="op">&lt;</span> B <span class="op">&gt;;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">auto</span> funcB<span class="op">(</span> <span class="at">const</span> vector<span class="op">&lt;</span> A <span class="op">&gt;&amp;</span> <span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">size_t</span><span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">auto</span> funcC<span class="op">(</span> <span class="at">const</span> vector<span class="op">&lt;</span> A <span class="op">&gt;&amp;</span> <span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">bool</span><span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="kw">auto</span> funcD<span class="op">(</span> function<span class="op">&lt;</span> B<span class="op">(</span> B<span class="op">,</span> <span class="at">const</span> A<span class="op">&amp;</span> <span class="op">)</span> <span class="op">&gt;,</span> B<span class="op">,</span> <span class="at">const</span> vector<span class="op">&lt;</span> A <span class="op">&gt;&amp;</span> <span class="op">)</span> <span class="op">-&gt;</span> B<span class="op">;</span></span></code></pre></div>
</div>

<div id="arguments" class="title-slide slide section level2"
number="9.3">
<h1><span class="header-section-number">9.3</span> Arguments</h1>

</div>
<div id="pass-by-value" class="slide section level3" number="9.3.1">
<h1><span class="header-section-number">9.3.1</span> Pass by value</h1>
<ul>
<li>When small and fast to copy</li>
<li>When you are going to move the value to take ownership of data</li>
</ul>
<div class="sourceCode" id="cb15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">auto</span> func<span class="op">(</span> <span class="dt">int</span> a<span class="op">,</span> <span class="dt">double</span> b <span class="op">);</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="kw">auto</span> C<span class="op">::</span>C<span class="op">(</span> string newValue <span class="op">)</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>    <span class="op">:</span> <span class="va">m_value</span><span class="op">(</span> move<span class="op">(</span> newValue <span class="op">)</span> <span class="op">)</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="op">{</span> <span class="op">}</span></span></code></pre></div>
<ul>
<li>Never pass the base class by value, use pointer or reference for
this scenario (slicing)</li>
</ul>
</div>
<div id="pass-by-reference" class="slide section level3" number="9.3.2">
<h1><span class="header-section-number">9.3.2</span> Pass by
reference</h1>
<ul>
<li>When large or otherwise slow to copy</li>
<li>When you need access to the actual object passed</li>
<li>When there has to be an object there</li>
</ul>
<div class="sourceCode" id="cb16"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">auto</span> func<span class="op">(</span> vector<span class="op">&lt;</span> string <span class="op">&gt;&amp;</span> lines <span class="op">)</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>    lines<span class="op">.</span>push_back<span class="op">(</span> <span class="st">&quot;EndOfFile&quot;</span> <span class="op">);</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="pass-by-pointer" class="slide section level3" number="9.3.3">
<h1><span class="header-section-number">9.3.3</span> Pass by
pointer</h1>
<ul>
<li>When large and slow to copy</li>
<li>When you need access to the actual object passed</li>
<li>When you accept that there might not be an object (nullptr)</li>
</ul>
<div class="sourceCode" id="cb17"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">auto</span> func<span class="op">(</span> vector<span class="op">&lt;</span> string <span class="op">&gt;*</span> lines <span class="op">)</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="cf">if</span> <span class="op">(</span> lines <span class="op">!=</span> <span class="kw">nullptr</span> <span class="op">)</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>        lines<span class="op">-&gt;</span>push_back<span class="op">(</span> <span class="st">&quot;EndOfFile&quot;</span> <span class="op">);</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="when-to-const-arguments" class="slide section level3"
number="9.3.4">
<h1><span class="header-section-number">9.3.4</span> When to const
arguments</h1>
<ul>
<li>As much as possible</li>
<li>As long as you do not need to modify the argument</li>
<li>As long as the argument type is const correct</li>
</ul>
<div class="sourceCode" id="cb18"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">auto</span> func<span class="op">(</span> <span class="at">const</span> vector<span class="op">&lt;</span> string <span class="op">&gt;&amp;</span> lines <span class="op">)</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="co">// lines.push_back( &quot;EndOfFile&quot; ); &lt;- error, lines is const</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="hidden-argument-this-and-the-dependency-implications"
class="slide section level3" number="9.3.5">
<h1><span class="header-section-number">9.3.5</span> Hidden argument
“this”, and the dependency implications</h1>
<ul>
<li>Methods have access to full object, consider using free functions
where possible</li>
<li>Methods must preserve the invariant of the object at all times</li>
<li>Free functions only need to produce some result from some
arguments</li>
<li>Methods requires the class and usually an object</li>
<li>Free functions are much easier to reuse, test and compose</li>
</ul>
</div>

<div id="return-value" class="title-slide slide section level2"
number="9.4">
<h1><span class="header-section-number">9.4</span> Return value</h1>

</div>
<div id="return-by-value" class="slide section level3" number="9.4.1">
<h1><span class="header-section-number">9.4.1</span> Return by
value</h1>
<ul>
<li>Mostly</li>
<li>When the function constructs the returned value</li>
<li>To protect against exposing internals to the application</li>
</ul>
<div class="sourceCode" id="cb19"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">auto</span> func<span class="op">(</span> <span class="op">)</span> <span class="op">-&gt;</span> vector<span class="op">&lt;</span> string <span class="op">&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    vector<span class="op">&lt;</span> string <span class="op">&gt;</span> result<span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>    result<span class="op">.</span>push_back<span class="op">(</span> <span class="st">&quot;StartOfFile&quot;</span> <span class="op">);</span></span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>Never return the base class by value, use pointer or reference for
this scenario (slicing)</li>
</ul>
</div>
<div id="return-by-reference" class="slide section level3"
number="9.4.2">
<h1><span class="header-section-number">9.4.2</span> Return by
reference</h1>
<ul>
<li>When the function returns access to a member or something guaranteed
to survive the call, so no local variables</li>
<li>When the function returns access to an object held by this object,
like in containers</li>
</ul>
<div class="sourceCode" id="cb20"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">class</span> C</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="kw">auto</span> func<span class="op">(</span> <span class="op">)</span> <span class="op">-&gt;</span> vector<span class="op">&lt;</span> string <span class="op">&gt;&amp;</span> <span class="co">// Bad, as it allows clients to change internal data</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>    <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>        <span class="cf">return</span> <span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>    <span class="op">}</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>    vector<span class="op">&lt;</span> string <span class="op">&gt;</span> <span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="return-by-pointer" class="slide section level3" number="9.4.3">
<h1><span class="header-section-number">9.4.3</span> Return by
pointer</h1>
<ul>
<li>When the function returns a potential access to a member or
something guaranteed to survive the call, so no local variables</li>
<li>When the function returns a potential access to an object held by
this object, like in containers</li>
<li>Note that this can be done by returning an optional&lt;&gt;, which
makes for clearer code</li>
</ul>
<div class="sourceCode" id="cb21"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">class</span> C</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>    <span class="kw">auto</span> func<span class="op">(</span> <span class="op">)</span> <span class="op">-&gt;</span> vector<span class="op">&lt;</span> string <span class="op">&gt;*</span> <span class="co">// Bad, as it allows clients to change internal data</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="op">{</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>        <span class="cf">if</span> <span class="op">(</span> <span class="va">m_myStrings</span><span class="op">.</span>empty<span class="op">()</span> <span class="op">)</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>            <span class="cf">return</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a>        <span class="cf">return</span> <span class="op">&amp;</span><span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>    <span class="op">}</span></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>    vector<span class="op">&lt;</span> string <span class="op">&gt;</span> <span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="when-to-const-returned-value" class="slide section level3"
number="9.4.4">
<h1><span class="header-section-number">9.4.4</span> When to const
returned value</h1>
<ul>
<li>When returning access to internals, by reference or pointer
<ul>
<li>This is to avoid having clients use the access to internals to break
the class invariant</li>
</ul></li>
<li>Also when operating on const data, including const methods</li>
</ul>
<div class="sourceCode" id="cb22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">class</span> C</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="op">{</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="kw">auto</span> func<span class="op">(</span> <span class="op">)</span> <span class="at">const</span> <span class="op">-&gt;</span> <span class="at">const</span> vector<span class="op">&lt;</span> string <span class="op">&gt;&amp;</span> <span class="co">//  Better, clients not allowed to change internal data, but structure revealed</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="op">{</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>        <span class="cf">return</span> <span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="op">}</span></span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a>    <span class="kw">auto</span> <span class="kw">operator</span><span class="op">+(</span> <span class="at">const</span> C<span class="op">&amp;</span> other <span class="op">)</span> <span class="at">const</span> <span class="op">-&gt;</span> <span class="at">const</span> C<span class="op">;</span> <span class="co">// Disallow a + b = c</span></span>
<span id="cb22-10"><a href="#cb22-10"></a></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    vector<span class="op">&lt;</span> string <span class="op">&gt;</span> <span class="va">m_myStrings</span><span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="return-value-optimization-rvo-and-nrvo"
class="slide section level3" number="9.4.5">
<h1><span class="header-section-number">9.4.5</span> Return value
optimization (RVO and NRVO)</h1>
<ul>
<li>This basically makes a lot of copying go away</li>
<li>Construct the object to return in the return statement</li>
<li>Or construct one object that is returned from all paths</li>
<li>Does not work for returning members, as they must be copied</li>
<li>Never std::move() in a return statement</li>
<li>Never enclose the returned value in parenthesis
<ul>
<li>return (“hello”); -&gt; This blocks RVO</li>
<li>return “hello”; -&gt; This does not block RVO, so a copy/move is
elided</li>
<li>return std::string(“hello”); -&gt; This does not block RVO, so a
copy/move is elided</li>
</ul></li>
</ul>
</div>
<div id="returning-more-than-one-thing" class="slide section level3"
number="9.4.6">
<h1><span class="header-section-number">9.4.6</span> Returning more than
one thing</h1>
<ul>
<li>Output parameters
<ul>
<li>Do not use this, as a general rule</li>
<li>In some cases can be faster, but this should be tested and measured
and the need for speed should be documented for the function</li>
</ul></li>
<li>Return a struct
<ul>
<li>This creates a single entity that can be returned</li>
<li>Can have any amount of data</li>
<li>Keep small, to avoid having to deal with large objects</li>
<li>Gives names to each field</li>
</ul></li>
<li>Return a class
<ul>
<li>Basically the same as for structs, but also implies some
invariant</li>
<li>More natural to have query methods on the returned class for
checking the returned value(s)</li>
<li>Example: std::string</li>
</ul></li>
</ul>
</div>

<div id="argument-order" class="title-slide slide section level2"
number="9.5">
<h1><span class="header-section-number">9.5</span> Argument order</h1>
<ul>
<li>When deciding the order of arguments a few things should be
considered
<ul>
<li>Default arguments
<ul>
<li>These, by language rules, must be last</li>
</ul></li>
<li>Common use
<ul>
<li>The arguments that would be “fixed” in a currying should be
first</li>
<li>This makes the STL incorrect, as the range of data to operate on
would vary, rather than the operation to perform
<ul>
<li>Not really a problem, it is always possible to
“convenience-function” around this</li>
</ul></li>
<li>There is a std::bind_front() that basically provides currying, in
C++20</li>
<li>There is a std::bind_back() to remedy the reversed currying, in
C++23</li>
</ul></li>
<li>Overloads
<ul>
<li>Should have the same order for arguments that are the same</li>
<li>If possible the less-arguments function should call the
more-argument function</li>
<li>This makes the difference in arguments potential default arguments
and the less-argument function can be removed</li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="contract" class="title-slide slide section level2"
number="9.6">
<h1><span class="header-section-number">9.6</span> Contract</h1>
<ul>
<li>Const methods
<ul>
<li>Const all methods that do not change the observable state of the
object</li>
<li>Cached calculations can be “mutable” so that they can be modified in
const methods</li>
<li>Do not change any observable state in a const method, ever</li>
<li>Mutexes must be mutable, since it is necessary to lock them even in
const methods
<ul>
<li>They are not really observable outside the class anyway, so this is
ok</li>
<li>If the method returns access to some internal data, the mutex must
remain locked
<ul>
<li>This calls for a locked_ptr type of return value</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="static-methods" class="title-slide slide section level2"
number="9.7">
<h1><span class="header-section-number">9.7</span> Static methods</h1>
<ul>
<li>Useful or just a complicated name for a free function</li>
<li>Gives the function a strong relation to the class
<ul>
<li>Easy for intellisense</li>
<li>Ok for constructor-like functions</li>
</ul></li>
<li>Often abused
<ul>
<li>Singleton anti-pattern</li>
<li>Unrelated operations</li>
<li>Java programming</li>
</ul></li>
</ul>
</div>

<div id="do-or-do-not" class="title-slide slide section level2"
number="9.8">
<h1><span class="header-section-number">9.8</span> Do or do not</h1>
<ul>
<li>This is about surprises, surprises are bad</li>
<li>Any function should either succeed or do nothing (observable)
<ul>
<li>Especially important for methods</li>
<li>Do not allow the system to get into a “halfway state”</li>
<li>Remember that exceptions can occur at nearly any point</li>
<li>Copying of native types and pointers do not throw, so this can be
done after the results are ready to set the new state</li>
<li>Basic order of operations then becomes
<ul>
<li>Check arguments and state
<ul>
<li>If these are bad or not compatible, no further processing, report
the problem</li>
</ul></li>
<li>Perform operation on temporary data
<ul>
<li>If this fails, only temporary data have been affected and these will
be cleaned up, report the problem</li>
</ul></li>
<li>Swap in results from temporary data to members
<ul>
<li>This should not be able to fail (only simple copying of non-throwing
data)</li>
</ul></li>
</ul></li>
<li>This is often simplified, but should be considered for all methods
modifying the object
<ul>
<li>Ending up in a halfway state is potentially difficult to figure out
and debug</li>
<li>Program is basically undefined behaviour from that point</li>
</ul></li>
<li>This will often be more lines, but correct code is better than cute
code</li>
</ul></li>
</ul>
</div>

<div id="pure-functions" class="title-slide slide section level2"
number="9.9">
<h1><span class="header-section-number">9.9</span> Pure functions</h1>
<ul>
<li>A pure function
<ul>
<li>is a function that only reads its arguments and returns a
result</li>
<li>always returns the same value when given the same arguments, allows
memoization</li>
<li>is allowed to change local variables, including pass by value
arguments</li>
<li>has no side effects</li>
<li>can be called at any time</li>
<li>can be called from any thread</li>
<li>is often easy to compose with other functions</li>
<li>is easy to test</li>
<li>is easy to reason about</li>
<li>can be implemented as a table lookup</li>
</ul></li>
<li>Make functions pure if possible
<ul>
<li>This may mean that the pure part is moved to another function and
then sent to the side-effect part later</li>
</ul></li>
<li>Methods can also be pure functions
<ul>
<li>This is not about pure virtuals, which is a different thing</li>
<li>Pure methods shall be const
<ul>
<li>Remember that the object itself is an argument</li>
</ul></li>
<li>Pure methods do not have the same flexibility as pure functions
<ul>
<li>They need the implicit argument “this”</li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="variables" class="title-slide slide section level2"
number="9.10">
<h1><span class="header-section-number">9.10</span> Variables</h1>

</div>
<div id="name-variables-after-what-they-represent"
class="slide section level3" number="9.10.1">
<h1><span class="header-section-number">9.10.1</span> Name variables
after what they represent</h1>
<ul>
<li>Not the type</li>
<li>Do not use abbreviations, generally</li>
<li>It is OK to use abbreviations or short names that are
<ul>
<li>Commonly known and unambigous in the business field</li>
<li>Loop index variables (i, j, k…)</li>
<li>Limited to a very small scope</li>
</ul></li>
<li>Most coding standards place some extra requirements on names, like
<ul>
<li>a_ prefix for arguments</li>
<li>m_ prefix for members</li>
<li>no prefix for locals</li>
<li>also statics and globals may have prefixes</li>
</ul></li>
</ul>
</div>
<div id="use-a-variable-for-a-single-purpose"
class="slide section level3" number="9.10.2">
<h1><span class="header-section-number">9.10.2</span> Use a variable for
a single purpose</h1>
<ul>
<li>There is some temptation to reuse variables for new purposes later
in functions, avoid this</li>
<li>It is possible to limit the scope of some variables
<ul>
<li>This makes them easier to reason about</li>
<li>Stack space can be reused by later variables, if this is a concern,
but it usually is not</li>
<li>While this does free up the name, avoid using the same name for
another variable</li>
</ul></li>
</ul>
</div>
<div id="const-variables-where-possible" class="slide section level3"
number="9.10.3">
<h1><span class="header-section-number">9.10.3</span> Const variables
where possible</h1>
<ul>
<li>Do not declare variables until they can be given a value
<ul>
<li>It is OK to call a function to get the value</li>
<li>Sometimes this function can be a lambda</li>
</ul></li>
<li>Do not change value of variables unless absolutely necessary
<ul>
<li>Mostly they do not need changing</li>
<li>Some do, mostly those that are used for iterations/loops</li>
<li>Subexpressions can be given their own names if a complex result is
needed</li>
</ul></li>
<li>So most variables can be const…</li>
<li>Const variables are easier to reason about</li>
<li>Even for the compiler, so sometimes it may allow for better
optimization as well</li>
</ul>
</div>
<div id="stack-vs-heap" class="slide section level3" number="9.10.4">
<h1><span class="header-section-number">9.10.4</span> Stack vs heap</h1>
<ul>
<li>Stack is much faster than heap
<ul>
<li>Avoid memory allocation</li>
<li>Hot in cache, heap is often cold</li>
</ul></li>
<li>Stack does not get fragmented
<ul>
<li>Fragmentation of the heap can lead to serious problems</li>
<li>Unable to allocate more memory</li>
<li>C++ can have, but nobody gave it, a garbage collector, so memory
lost is lost</li>
<li>There may be plenty of memory free, but only in small chunks</li>
</ul></li>
<li>Do not use the heap unless necessary</li>
<li>Stack is limited in size, much smaller than heap
<ul>
<li>Stacks tend to be close to 1 MB though, so most local variables
should reside on stack</li>
<li>Some objects may need the heap
<ul>
<li>Strings and collections tend to use the heap for storage even though
they themselves can be on the stack</li>
<li>Arrays tend to be on the stack unless explicitly on the heap</li>
<li>Some objects that are to be used polymorphically will live naturally
on the heap</li>
<li>Objects that must survive the returning from the function</li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="general" class="title-slide slide section level2"
number="9.11">
<h1><span class="header-section-number">9.11</span> General</h1>

</div>
<div id="size-of-function" class="slide section level3" number="9.11.1">
<h1><span class="header-section-number">9.11.1</span> Size of
function</h1>
<ul>
<li>There is no real consensus on correct function size, beyond
“small”</li>
<li>One study suggested about 40 lines for less bugs</li>
<li>The more modern ideas are smaller than this</li>
<li>I suggest “about 7 statements” as a “limit”
<ul>
<li>This is just a gut feeling</li>
<li>A method properly written with testing of arguments and exception
safety can often be larger than this</li>
<li>Most algorithms can be described in 7 steps or less
<ul>
<li>Some of those steps may be complex and require separate
functions</li>
</ul></li>
<li>Many functions will be smaller, one to three statements</li>
<li>Some functions will be larger
<ul>
<li>Functions that initialize data</li>
<li>Functions that operates on large structures with many fields</li>
<li>Functions that are just complex</li>
</ul></li>
<li>Guideline, not rule</li>
</ul></li>
<li>Large functions can be split into smaller functions, with
descriptive names</li>
</ul>
</div>
<div id="functions-that-do-different-things-depending-on-an-argument"
class="slide section level3" number="9.11.2">
<h1><span class="header-section-number">9.11.2</span> Functions that do
different things depending on an argument</h1>
<ul>
<li>Such arguments are often constant at the call-site</li>
<li>Such arguments are often bool or some small enum</li>
<li>This should normally be avoided</li>
<li>Split into several functions that then do not need the argument</li>
<li>If called with varying values for the argument, make a convenience
function that handles the selecting of the function to call</li>
</ul>
</div>
<div id="function-decorations" class="slide section level3"
number="9.11.3">
<h1><span class="header-section-number">9.11.3</span> Function
decorations</h1>
<ul>
<li>Pure virtuals must have “= 0”, as per language rules</li>
<li>Overriding a virtual method shall have “override” to catch bugs, but
not “virtual”</li>
<li>The leaf class shall declare overridden virtuals as “final”, still
not “virtual”</li>
<li>Functions that do not throw shall be “noexcept”, this can help the
optimizer</li>
<li>Destructors shall be “noexcept”, never let exceptions escape
destructors</li>
<li>All methods that do not change the visible state of the object shall
be “const”</li>
</ul>
</div>

<div id="constexpr" class="title-slide slide section level2"
number="9.12">
<h1><span class="header-section-number">9.12</span> constexpr</h1>
<ul>
<li>Can be run at compiletime, or runtime</li>
<li>Does not allow undefined behaviour, less bugs</li>
<li>More capabilities as the language continues to grow</li>
<li>When run at compiletime, can result in massive optimizations
<ul>
<li>At the cost of compile speed</li>
</ul></li>
<li>When possible, use “constexpr” on functions and methods, including
constructors and destructors (C++20)</li>
</ul>
</div>

</body>
</html>
